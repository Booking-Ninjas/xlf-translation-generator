<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLF Translation Generator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç XLF Translation Generator</h1>
            <p>Manage translations via Google Sheets</p>
        </div>
        <!-- Import Section -->
        <div class="card">
            <h2><span class="card-icon">üì•</span> Import XLF to Google Sheets</h2>
            
            <div class="file-upload" id="importUpload">
                <input type="file" id="importFile" accept=".xlf" style="display:none;">
                <div class="file-upload-label">
                    üìÅ Click anywhere to select XLF file<br>
                    <small>Only en_US source language files are supported</small>
                </div>
                <div class="file-name" id="importFileName"></div>
            </div>
            
            <div id="categorySelection" style="display: none;">
                <h3 style="font-size: 1em; color: #444; margin-bottom: 10px; font-weight: 500;">Select Categories to Import:</h3>
                <div id="categoryList" class="category-list"></div>
            </div>
            
            <button class="btn" id="importBtn" disabled>Import to Google Sheets</button>
            
            <div class="loader" id="importLoader"></div>
            <div class="message" id="importMessage"></div>
            
        </div>
        <!-- Export Section -->
        <div class="card">
            <h2><span class="card-icon">üì§</span> Export Translated XLF</h2>
            
            <label for="languageSelect" style="display: block; margin-bottom: 10px; color: #666; font-weight: 600;">
                Select Target Language:
            </label>
            <select id="languageSelect" disabled>
                <option value="">Loading languages...</option>
            </select>
            <button class="btn" id="exportBtn">Export XLF with Translations</button>
            
            <div class="loader" id="exportLoader"></div>
            <div class="message" id="exportMessage"></div>
        </div>
        <!-- Info Section -->
        <div class="card">
            <div class="info-box">
                <h3>‚ÑπÔ∏è How to Use</h3>
                <ul>
                    <li><strong>Import:</strong> Upload XLF file (source-language="en_US") to sync with Google Sheets</li>
                    <li><strong>Edit:</strong> Open Google Sheets and add/edit translations</li>
                    <li><strong>Export:</strong> Select language and download translated XLF anytime</li>
                </ul>
                <p style="margin-top: 10px; color: #666;">
                    <strong>Note:</strong> If English text changes during import, all translations for that segment will be cleared.
                </p>
            </div>
        </div>
    </div>
    <script>
        let importedFile = null;
        let parsedCategories = [];
        let selectedCategories = new Set();
        let defaultExcludedCategories = ['CustomLabel']; // Fallback, will be loaded from server
        
        // Load configuration from server
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                if (data.success && data.defaultExcludedCategories) {
                    defaultExcludedCategories = data.defaultExcludedCategories;
                    console.log('Loaded excluded categories from config:', defaultExcludedCategories);
                }
            } catch (error) {
                console.error('Failed to load config, using defaults:', error);
            }
        }
        // Load available languages on page load
        async function loadLanguages() {
            try {
                const response = await fetch('/api/languages');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('languageSelect');
                    select.innerHTML = '<option value="">Select a language...</option>';
                    
                    data.languages.forEach(lang => {
                        const option = document.createElement('option');
                        option.value = lang;
                        option.textContent = lang;
                        select.appendChild(option);
                    });
                    
                    select.disabled = false;
                }
            } catch (error) {
                console.error('Failed to load languages:', error);
            }
        }
        // Import file selection
        document.getElementById('importFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                importedFile = file;
                document.getElementById('importFileName').textContent = `Selected: ${file.name}`;
                
                // Parse file to extract categories
                await extractAndDisplayCategories(file);
            }
        });
        
        // Extract categories from XLF file
        async function extractAndDisplayCategories(file) {
            try {
                let text = await file.text();
                
                // Handle nested XML declarations (common in some XLF files)
                // Remove duplicate XML declarations that appear after the first one
                const xmlDeclRegex = /<\?xml[^?]*\?>/g;
                const matches = text.match(xmlDeclRegex);
                if (matches && matches.length > 1) {
                    console.log('Found nested XML declarations, cleaning up...');
                    // Keep only the first XML declaration
                    text = text.replace(xmlDeclRegex, (match, offset) => {
                        return offset === text.indexOf(match) ? match : '';
                    });
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');
                
                // Check for parsing errors
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    console.error('XML Parser Error:', parserError.textContent);
                    throw new Error('Invalid XML format: ' + parserError.textContent);
                }
                
                // Extract all trans-unit IDs (handles nested structure)
                const transUnits = xmlDoc.getElementsByTagName('trans-unit');
                const categorySet = new Set();
                
                console.log('Found trans-units:', transUnits.length);
                
                if (transUnits.length === 0) {
                    throw new Error('No trans-unit elements found in XLF file');
                }
                
                for (let unit of transUnits) {
                    const id = unit.getAttribute('id');
                    if (id) {
                        // Extract category (first part before the first dot)
                        const category = id.split('.')[0];
                        if (category) {
                            categorySet.add(category);
                            console.log('Found category:', category, 'from ID:', id);
                        }
                    }
                }
                
                // Sort categories alphabetically
                parsedCategories = Array.from(categorySet).sort();
                console.log('Total unique categories:', parsedCategories);
                
                if (parsedCategories.length === 0) {
                    throw new Error('No categories found in XLF file');
                }
                
                // Initialize selected categories (all except those in defaultExcludedCategories)
                selectedCategories.clear();
                parsedCategories.forEach(cat => {
                    if (!defaultExcludedCategories.includes(cat)) {
                        selectedCategories.add(cat);
                    }
                });
                
                console.log('Selected categories by default:', Array.from(selectedCategories));
                console.log('Excluded categories:', defaultExcludedCategories);
                
                // Display category checkboxes
                displayCategories();
                
                // Enable import button
                document.getElementById('importBtn').disabled = false;
                
            } catch (error) {
                console.error('Failed to parse categories:', error);
                alert('Failed to parse XLF file: ' + error.message + '\n\nPlease check the browser console for more details.');
                document.getElementById('importBtn').disabled = true;
            }
        }
        
        // Display category checkboxes
        function displayCategories() {
            const categoryList = document.getElementById('categoryList');
            const categorySelection = document.getElementById('categorySelection');
            
            console.log('displayCategories called with:', parsedCategories);
            console.log('categorySelection element:', categorySelection);
            console.log('categoryList element:', categoryList);
            
            if (parsedCategories.length === 0) {
                console.log('No categories to display');
                categorySelection.style.display = 'none';
                return;
            }
            
            categoryList.innerHTML = '';
            
            parsedCategories.forEach(category => {
                const label = document.createElement('label');
                label.className = 'category-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = category;
                checkbox.checked = selectedCategories.has(category);
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedCategories.add(category);
                    } else {
                        selectedCategories.delete(category);
                    }
                });
                
                const text = document.createTextNode(' ' + category);
                
                label.appendChild(checkbox);
                label.appendChild(text);
                categoryList.appendChild(label);
            });
            
            console.log('Setting categorySelection display to block');
            categorySelection.style.display = 'block';
        }
        // Trigger file input on area click
        document.getElementById('importUpload').addEventListener('click', (e) => {
            if (e.target.id === 'importFileName') return;
            document.getElementById('importFile').click();
        });
        // Import XLF to Google Sheets
        document.getElementById('importBtn').addEventListener('click', async () => {
            if (!importedFile) return;
            
            // Validate at least one category is selected
            if (selectedCategories.size === 0) {
                alert('Please select at least one category to import');
                return;
            }
            
            const btn = document.getElementById('importBtn');
            const loader = document.getElementById('importLoader');
            const message = document.getElementById('importMessage');
            btn.disabled = true;
            loader.style.display = 'block';
            message.style.display = 'none';
            try {
                const formData = new FormData();
                formData.append('xlf', importedFile);
                formData.append('categories', JSON.stringify(Array.from(selectedCategories)));
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    message.className = 'message success';
                    message.textContent = data.message;
                    message.style.display = 'block';
                } else {
                    message.className = 'message error';
                    message.textContent = `Error: ${data.error}`;
                    message.style.display = 'block';
                }
            } catch (error) {
                message.className = 'message error';
                message.textContent = `Error: ${error.message}`;
                message.style.display = 'block';
            } finally {
                loader.style.display = 'none';
                btn.disabled = false;
            }
        });
        // Export XLF
        document.getElementById('exportBtn').addEventListener('click', async () => {
            const language = document.getElementById('languageSelect').value;
            
            if (!language) {
                alert('Please select a target language');
                return;
            }
            const btn = document.getElementById('exportBtn');
            const loader = document.getElementById('exportLoader');
            const message = document.getElementById('exportMessage');
            btn.disabled = true;
            loader.style.display = 'block';
            message.style.display = 'none';
            try {
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ language })
                });
                if (response.ok) {
                    // Download file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    a.download = `translation_${language}_${dateStr}.xlf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    message.className = 'message success';
                    message.textContent = `‚úÖ XLF file exported successfully for ${language}`;
                    message.style.display = 'block';
                } else {
                    const data = await response.json();
                    message.className = 'message error';
                    message.textContent = `Error: ${data.error}`;
                    message.style.display = 'block';
                }
            } catch (error) {
                message.className = 'message error';
                message.textContent = `Error: ${error.message}`;
                message.style.display = 'block';
            } finally {
                loader.style.display = 'none';
                btn.disabled = false;
            }
        });
        // Initialize
        loadConfig();
        loadLanguages();
    </script>
</body>
</html>
